local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

local function getInternalTable()
    local Packages = ReplicatedStorage:FindFirstChild("Packages")
    if not Packages then return nil end
    
    local SynchronizerModule = Packages:FindFirstChild("Synchronizer")
    if not SynchronizerModule then return nil end
    
    local success, synchronizer = pcall(require, SynchronizerModule)
    if not success or not synchronizer then return nil end
    
    local GetMethod = synchronizer.Get
    if type(GetMethod) ~= "function" then
        return nil
    end
    
    for i = 1, 5 do
        local success, upvalue = pcall(getupvalue, GetMethod, i)
        if success and type(upvalue) == "table" then
            if upvalue.___private or upvalue.___channels or upvalue.___data then
                return upvalue
            end
            
            for k, v in pairs(upvalue) do
                if type(k) == "string" and k:match("^Plot_") or type(v) == "table" then
                    return upvalue
                end
            end
        end
    end
    
    local success, env = pcall(getfenv, GetMethod)
    if success and env and env.self then
        return env.self
    end
    
    return nil
end

local SynchronizerInternal = {
    _cache = {},
    _dataTable = nil
}

task.spawn(function()
    local attempts = 0
    while attempts < 10 and not SynchronizerInternal._dataTable do
        SynchronizerInternal._dataTable = getInternalTable()
        if not SynchronizerInternal._dataTable then
            task.wait(1)
            attempts = attempts + 1
        end
    end
end)

local function stealthGet(plotName)
    if not plotName or type(plotName) ~= "string" then
        return nil
    end
    
    if SynchronizerInternal._cache[plotName] == false then
        return nil
    end
    
    if SynchronizerInternal._dataTable then
        local keys = {
            plotName,
            "Plot_" .. plotName,
            "Plot" .. plotName,
            plotName .. "_Channel",
            "Channel_" .. plotName
        }
        
        for _, key in ipairs(keys) do
            if SynchronizerInternal._dataTable[key] then
                SynchronizerInternal._cache[plotName] = SynchronizerInternal._dataTable[key]
                return SynchronizerInternal._dataTable[key]
            end
        end
        
        for k, v in pairs(SynchronizerInternal._dataTable) do
            if type(k) == "string" and (k == plotName or k:find(plotName, 1, true)) then
                if type(v) == "table" then
                    SynchronizerInternal._cache[plotName] = v
                    return v
                end
            end
        end
    end
    
    SynchronizerInternal._cache[plotName] = false
    return nil
end

local function stealthGetProperty(channel, property)
    if not channel or type(channel) ~= "table" then
        return nil
    end
    
    if channel[property] then
        return channel[property]
    end
    
    if type(channel.Get) == "function" then
        local success, result = pcall(channel.Get, channel, property)
        if success then
            return result
        end
    end
    
    local altNames = {
        Owner = {"owner", "Owner", "plotOwner", "PlotOwner"},
        AnimalList = {"animalList", "AnimalList", "animals", "Animals", "pets"}
    }
    
    if altNames[property] then
        for _, alt in ipairs(altNames[property]) do
            if channel[alt] then
                return channel[alt]
            end
        end
    end
    
    return nil
end

local autoStealEnabled = true
local selectedTargetIndex = 1
local currentStealProgress = 0
local isCurrentlyStealing = false

local Packages = ReplicatedStorage:WaitForChild("Packages")
local Datas = ReplicatedStorage:WaitForChild("Datas")
local Shared = ReplicatedStorage:WaitForChild("Shared")
local Utils = ReplicatedStorage:WaitForChild("Utils")

local AnimalsData, AnimalsShared, NumberUtils
task.spawn(function()
    for i = 1, 10 do
        local success1, data = pcall(require, Datas:WaitForChild("Animals"))
        local success2, shared = pcall(require, Shared:WaitForChild("Animals"))
        local success3, utils = pcall(require, Utils:WaitForChild("NumberUtils"))
        
        if success1 and data then
            AnimalsData = data
        end
        if success2 and shared then
            AnimalsShared = shared
        end
        if success3 and utils then
            NumberUtils = utils
        end
        
        if AnimalsData and AnimalsShared and NumberUtils then
            break
        end
        task.wait(0.5)
    end
end)

local allAnimalsCache = {}
local InternalStealCache = {}
local PromptMemoryCache = {}

local function isMyBaseAnimal(animalData)
    if not animalData or not animalData.plot then
        return false
    end
    
    local plots = workspace:FindFirstChild("Plots")
    if not plots then
        return false
    end
    
    local plot = plots:FindFirstChild(animalData.plot)
    if not plot then
        return false
    end
    
    local channel = stealthGet(plot.Name)
    if channel then
        local owner = stealthGetProperty(channel, "Owner")
        if owner then
            if typeof(owner) == "Instance" and owner:IsA("Player") then
                return owner.UserId == LocalPlayer.UserId
            elseif typeof(owner) == "table" and owner.UserId then
                return owner.UserId == LocalPlayer.UserId
            elseif typeof(owner) == "Instance" then
                return owner == LocalPlayer
            end
        end
    end
    
    local sign = plot:FindFirstChild("PlotSign")
    if sign then
        local yourBase = sign:FindFirstChild("YourBase")
        if yourBase and yourBase:IsA("BillboardGui") then
            return yourBase.Enabled == true
        end
    end
    
    return false
end

local function get_top_3_pets()
    local topPets = {}
    
    for _, animalData in ipairs(allAnimalsCache) do
        if not isMyBaseAnimal(animalData) then
            table.insert(topPets, {
                petName = animalData.name or "Unknown",
                mpsText = animalData.genText or "$0/s",
                mpsValue = animalData.genValue or 0,
                owner = animalData.owner or "Unknown",
                plot = animalData.plot or "Unknown",
                slot = animalData.slot or "1",
                uid = animalData.uid or "",
                mutation = animalData.mutation or "None",
                animalData = animalData
            })
        end
        
        if #topPets >= 3 then
            break
        end
    end
    
    return topPets
end

local function findProximityPromptForAnimal(animalData)
    if not animalData then return nil end
    
    local cachedPrompt = PromptMemoryCache[animalData.uid]
    if cachedPrompt and cachedPrompt.Parent then
        return cachedPrompt
    end
    
    local plot = workspace.Plots:FindFirstChild(animalData.plot)
    if not plot then return nil end
    
    local podiums = plot:FindFirstChild("AnimalPodiums")
    if not podiums then return nil end
    
    local podium = podiums:FindFirstChild(animalData.slot)
    if not podium then return nil end
    
    local base = podium:FindFirstChild("Base")
    if not base then return nil end
    
    local spawn = base:FindFirstChild("Spawn")
    if not spawn then return nil end
    
    local attach = spawn:FindFirstChild("PromptAttachment")
    if not attach then return nil end
    
    for _, p in ipairs(attach:GetChildren()) do
        if p:IsA("ProximityPrompt") then
            PromptMemoryCache[animalData.uid] = p
            return p
        end
    end
    
    return nil
end

local function buildStealCallbacks(prompt)
    if InternalStealCache[prompt] then return end
    
    local data = {
        holdCallbacks = {},
        triggerCallbacks = {},
        ready = true,
    }
    
    local ok1, conns1 = pcall(getconnections, prompt.PromptButtonHoldBegan)
    if ok1 and type(conns1) == "table" then
        for _, conn in ipairs(conns1) do
            if type(conn.Function) == "function" then
                table.insert(data.holdCallbacks, conn.Function)
            end
        end
    end
    
    local ok2, conns2 = pcall(getconnections, prompt.Triggered)
    if ok2 and type(conns2) == "table" then
        for _, conn in ipairs(conns2) do
            if type(conn.Function) == "function" then
                table.insert(data.triggerCallbacks, conn.Function)
            end
        end
    end
    
    if (#data.holdCallbacks > 0) or (#data.triggerCallbacks > 0) then
        InternalStealCache[prompt] = data
    end
end

local function runCallbackList(list)
    for _, fn in ipairs(list) do
        task.spawn(fn)
    end
end

local function executeInternalStealAsync(prompt)
    local data = InternalStealCache[prompt]
    if not data or not data.ready then return false end
    
    data.ready = false
    
    -- Начинаем прогресс кражи
    isCurrentlyStealing = true
    local startTime = tick()
    local stealDuration = 1.42 -- Длительность кражи
    
    task.spawn(function()
        if #data.holdCallbacks > 0 then
            runCallbackList(data.holdCallbacks)
        end
        
        -- Анимация прогресса кражи
        while tick() - startTime < stealDuration do
            local progress = (tick() - startTime) / stealDuration
            currentStealProgress = math.clamp(progress * 100, 0, 100)
            task.wait(0.05)
        end
        
        if #data.triggerCallbacks > 0 then
            runCallbackList(data.triggerCallbacks)
        end
        
        task.wait()
        data.ready = true
        
        -- Завершаем прогресс
        isCurrentlyStealing = false
        currentStealProgress = 0
    end)
    
    return true
end

local function attemptSteal(prompt)
    if not prompt or not prompt.Parent then
        return false
    end
    
    buildStealCallbacks(prompt)
    if not InternalStealCache[prompt] then
        return false
    end
    
    return executeInternalStealAsync(prompt)
end

local function prebuildStealCallbacks()
    for uid, prompt in pairs(PromptMemoryCache) do
        if prompt and prompt.Parent then
            buildStealCallbacks(prompt)
        end
    end
end

task.spawn(function()
    while task.wait(2) do
        if autoStealEnabled then
            prebuildStealCallbacks()
        end
    end
end)

local plotChannels = {}
local lastAnimalData = {}
local scannerConnections = {}

local function getAnimalHash(animalList)
    if not animalList then return "" end
    local hash = ""
    for slot, data in pairs(animalList) do
        if type(data) == "table" then
            hash = hash .. tostring(slot) .. tostring(data.Index) .. tostring(data.Mutation)
        end
    end
    return hash
end

local function scanSinglePlot(plot)
    pcall(function()        
        local plotUID = plot.Name
        local channel = stealthGet(plotUID)
        if not channel then return end
        
        local animalList = stealthGetProperty(channel, "AnimalList")
        local currentHash = getAnimalHash(animalList)
        if lastAnimalData[plotUID] == currentHash then
            return
        end
        lastAnimalData[plotUID] = currentHash
        
        for i = #allAnimalsCache, 1, -1 do
            if allAnimalsCache[i].plot == plot.Name then
                table.remove(allAnimalsCache, i)
            end
        end
        
        local owner = stealthGetProperty(channel, "Owner")
        if not owner or not Players:FindFirstChild(owner.Name) then
            for i = #allAnimalsCache, 1, -1 do
                if allAnimalsCache[i].plot == plot.Name then
                    table.remove(allAnimalsCache, i)
                end
            end
            return
        end
        
        local ownerName = owner and owner.Name or "Unknown"
        if not animalList then return end
        
        for slot, animalData in pairs(animalList) do
            if type(animalData) == "table" then
                local animalName = animalData.Index
                local animalInfo = AnimalsData[animalName]
                if not animalInfo then continue end
                
                local mutation = animalData.Mutation or "None"
                local traits = (animalData.Traits and #animalData.Traits > 0) and table.concat(animalData.Traits, ", ") or "None"
                
                local genValue = AnimalsShared:GetGeneration(animalName, animalData.Mutation, animalData.Traits, nil)
                local genText = "$" .. NumberUtils:ToString(genValue) .. "/s"
                
                table.insert(allAnimalsCache, {
                    name = animalInfo.DisplayName or animalName,
                    genText = genText,
                    genValue = genValue,
                    mutation = mutation,
                    traits = traits,
                    owner = ownerName,
                    plot = plot.Name,
                    slot = tostring(slot),
                    uid = plot.Name .. "_" .. tostring(slot),
                })
            end
        end
        
        table.sort(allAnimalsCache, function(a, b)
            return a.genValue > b.genValue
        end)
    end)
end

local function setupPlotListener(plot)
    if plotChannels[plot.Name] then return end
    
    local channel
    local retries = 0
    local maxRetries = 3
    
    while not channel and retries < maxRetries do
        channel = stealthGet(plot.Name)
        if channel then
            break
        else
            retries = retries + 1
            if retries < maxRetries then
                task.wait(0.3)
            end
        end
    end
    
    if not channel then return end
    plotChannels[plot.Name] = true
    
    scanSinglePlot(plot)
    
    local c1 = plot.DescendantAdded:Connect(function()
        task.wait(0.05)
        scanSinglePlot(plot)
    end)
    table.insert(scannerConnections, c1)
    
    local c2 = plot.DescendantRemoving:Connect(function()
        task.wait(0.05)
        scanSinglePlot(plot)
    end)
    table.insert(scannerConnections, c2)
    
    local c3 = task.spawn(function()
        while plot.Parent and plotChannels[plot.Name] do
            task.wait(3)
            scanSinglePlot(plot)
        end
    end)
    table.insert(scannerConnections, c3)
end

local function initializePlotScanner()
    local plots = workspace:FindFirstChild("Plots")
    if not plots then
        for i = 1, 30 do
            plots = workspace:FindFirstChild("Plots")
            if plots then break end
            task.wait(0.5)
        end
        if not plots then
            return
        end
    end
    
    for _, plot in ipairs(plots:GetChildren()) do
        task.spawn(setupPlotListener, plot)
    end
    
    local newPlotConnection = plots.ChildAdded:Connect(function(plot)
        task.wait(0.2)
        task.spawn(setupPlotListener, plot)
    end)
    table.insert(scannerConnections, newPlotConnection)
    
    local removedPlotConnection = plots.ChildRemoved:Connect(function(plot)
        plotChannels[plot.Name] = nil
        lastAnimalData[plot.Name] = nil
        
        for i = #allAnimalsCache, 1, -1 do
            if allAnimalsCache[i].plot == plot.Name then
                table.remove(allAnimalsCache, i)
            end
        end
    end)
    table.insert(scannerConnections, removedPlotConnection)
end

-- GUI элементы
local screenGui, frame, statusLabel, targetLabel, petButtons, toggleButton, stealStatusLabel, progressBar, progressFill, progressText

-- Мобильный GUI (уменьшенный)
local function createMobileGUI()
    -- Проверяем, существует ли PlayerGui
    if not PlayerGui then
        warn("PlayerGui не найден! Ожидание...")
        for i = 1, 30 do
            PlayerGui = LocalPlayer:FindFirstChild("PlayerGui")
            if PlayerGui then break end
            task.wait(0.5)
        end
        if not PlayerGui then
            warn("PlayerGui так и не был найден!")
            return false
        end
    end
    
    -- Удаляем старый GUI если существует
    if screenGui and screenGui.Parent then
        screenGui:Destroy()
    end
    
    -- Создаем ScreenGui с правильными настройками для мобильных устройств
    screenGui = Instance.new("ScreenGui")
    screenGui.Name = "AutoStealUI_Mobile"
    screenGui.ResetOnSpawn = false
    screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    screenGui.DisplayOrder = 100
    screenGui.IgnoreGuiInset = true
    
    -- Уменьшенные размеры для мобильных устройств
    local isMobile = UserInputService.TouchEnabled
    local frameWidth = isMobile and 250 or 230 -- Уменьшено
    local frameHeight = isMobile and 210 or 190 -- Уменьшено
    
    frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, frameWidth, 0, frameHeight)
    frame.Position = UDim2.new(0.5, -frameWidth/2, 0.05, 0)
    frame.AnchorPoint = Vector2.new(0.5, 0)
    frame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    frame.BackgroundTransparency = 0.2
    frame.BorderSizePixel = 0
    frame.ZIndex = 100
    frame.Parent = screenGui

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6) -- Уменьшен угол
    corner.Parent = frame

    local stroke = Instance.new("UIStroke")
    stroke.Color = Color3.fromRGB(180, 0, 255)
    stroke.Thickness = 1.5 -- Уменьшена толщина
    stroke.Transparency = 0.5
    stroke.Parent = frame

    -- Перетаскивание только на ПК
    if not isMobile then
        local dragging = false
        local dragInput, mousePos, framePos

        frame.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = true
                mousePos = input.Position
                framePos = frame.Position
                
                input.Changed:Connect(function()
                    if input.UserInputState == Enum.UserInputState.End then
                        dragging = false
                    end
                end)
            end
        end)

        frame.InputChanged:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseMovement then
                dragInput = input
            end
        end)

        UserInputService.InputChanged:Connect(function(input)
            if input == dragInput and dragging then
                local delta = input.Position - mousePos
                frame.Position = UDim2.new(
                    framePos.X.Scale,
                    framePos.X.Offset + delta.X,
                    framePos.Y.Scale,
                    framePos.Y.Offset + delta.Y
                )
            end
        end)
    end

    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1, -10, 0, 20) -- Уменьшено
    titleLabel.Position = UDim2.new(0, 5, 0, 3) -- Смещено вверх
    titleLabel.BackgroundTransparency = 1
    titleLabel.Text = "NexoraHub AutoGrab"
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextSize = isMobile and 12 or 14 -- Уменьшено
    titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.ZIndex = 101
    titleLabel.Parent = frame

    local titleGradient = Instance.new("UIGradient")
    titleGradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.fromRGB(180, 0, 255)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 255, 255))
    }
    titleGradient.Parent = titleLabel

    statusLabel = Instance.new("TextLabel")
    statusLabel.Size = UDim2.new(0, 60, 0, 18) -- Уменьшено
    statusLabel.Position = UDim2.new(1, -65, 0, 4) -- Смещено
    statusLabel.BackgroundTransparency = 1
    statusLabel.Text = "ON"
    statusLabel.Font = Enum.Font.GothamBold
    statusLabel.TextSize = isMobile and 10 or 12 -- Уменьшено
    statusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
    statusLabel.TextXAlignment = Enum.TextXAlignment.Right
    statusLabel.ZIndex = 101
    statusLabel.Parent = frame

    targetLabel = Instance.new("TextLabel")
    targetLabel.Size = UDim2.new(1, -10, 0, 18) -- Уменьшено
    targetLabel.Position = UDim2.new(0, 5, 0, 28) -- Смещено
    targetLabel.BackgroundTransparency = 1
    targetLabel.Text = "Current: Searching..."
    targetLabel.Font = Enum.Font.GothamBold
    targetLabel.TextSize = isMobile and 9 or 11 -- Уменьшено
    targetLabel.TextColor3 = Color3.fromRGB(255, 255, 100)
    targetLabel.TextXAlignment = Enum.TextXAlignment.Left
    targetLabel.TextTruncate = Enum.TextTruncate.AtEnd
    targetLabel.ZIndex = 101
    targetLabel.Parent = frame

    -- Статус кражи
    stealStatusLabel = Instance.new("TextLabel")
    stealStatusLabel.Size = UDim2.new(1, -10, 0, 16) -- Уменьшено
    stealStatusLabel.Position = UDim2.new(0, 5, 0, 50) -- Смещено
    stealStatusLabel.BackgroundTransparency = 1
    stealStatusLabel.Text = "Steal: Ready"
    stealStatusLabel.Font = Enum.Font.GothamBold
    stealStatusLabel.TextSize = isMobile and 8 or 10 -- Уменьшено
    stealStatusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
    stealStatusLabel.TextXAlignment = Enum.TextXAlignment.Left
    stealStatusLabel.ZIndex = 101
    stealStatusLabel.Parent = frame

    -- Полоска прогресса кражи (уменьшенная)
    progressBar = Instance.new("Frame")
    progressBar.Size = UDim2.new(1, -20, 0, 10) -- Уменьшена высота
    progressBar.Position = UDim2.new(0, 10, 0, 70) -- Смещено
    progressBar.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    progressBar.BorderSizePixel = 0
    progressBar.ZIndex = 101
    progressBar.Parent = frame
    
    local progressBarCorner = Instance.new("UICorner")
    progressBarCorner.CornerRadius = UDim.new(0, 5) -- Уменьшен угол
    progressBarCorner.Parent = progressBar
    
    progressFill = Instance.new("Frame")
    progressFill.Size = UDim2.new(0, 0, 1, 0)
    progressFill.Position = UDim2.new(0, 0, 0, 0)
    progressFill.BackgroundColor3 = Color3.fromRGB(100, 255, 100)
    progressFill.BorderSizePixel = 0
    progressFill.ZIndex = 102
    progressFill.Parent = progressBar
    
    local progressFillCorner = Instance.new("UICorner")
    progressFillCorner.CornerRadius = UDim.new(0, 5)
    progressFillCorner.Parent = progressFill
    
    progressText = Instance.new("TextLabel")
    progressText.Size = UDim2.new(1, 0, 1, 0)
    progressText.Position = UDim2.new(0, 0, 0, 0)
    progressText.BackgroundTransparency = 1
    progressText.Text = "0%"
    progressText.Font = Enum.Font.GothamBold
    progressText.TextSize = isMobile and 7 or 9 -- Уменьшено
    progressText.TextColor3 = Color3.fromRGB(255, 255, 255)
    progressText.ZIndex = 103
    progressText.Parent = progressBar

    local top3Label = Instance.new("TextLabel")
    top3Label.Size = UDim2.new(1, -10, 0, 16) -- Уменьшено
    top3Label.Position = UDim2.new(0, 5, 0, 85) -- Смещено
    top3Label.BackgroundTransparency = 1
    top3Label.Text = "Select:"
    top3Label.Font = Enum.Font.GothamBold
    top3Label.TextSize = isMobile and 8 or 10 -- Уменьшено
    top3Label.TextColor3 = Color3.fromRGB(200, 200, 200)
    top3Label.TextXAlignment = Enum.TextXAlignment.Left
    top3Label.ZIndex = 101
    top3Label.Parent = frame
    
    petButtons = {}
    
    local buttonHeight = isMobile and 24 or 22 -- Уменьшено
    local buttonSpacing = isMobile and 28 or 26 -- Уменьшено
    local startY = 105 -- Смещено

    for i = 1, 3 do
        local petButton = Instance.new("TextButton")
        petButton.Size = UDim2.new(0, frameWidth - 20, 0, buttonHeight)
        petButton.Position = UDim2.new(0, 10, 0, startY + (i - 1) * buttonSpacing)
        petButton.BackgroundColor3 = Color3.fromRGB(15, 0, 15)
        petButton.BackgroundTransparency = 0.15
        petButton.BorderSizePixel = 0
        petButton.Text = string.format("#%d: ...", i) -- Укорочено
        petButton.Font = Enum.Font.Gotham
        petButton.TextSize = isMobile and 8 or 10 -- Уменьшено
        petButton.TextColor3 = Color3.fromRGB(200, 200, 200)
        petButton.AutoButtonColor = false
        petButton.TextXAlignment = Enum.TextXAlignment.Left
        petButton.ZIndex = 101
        petButton.Parent = frame
        
        local petCorner = Instance.new("UICorner")
        petCorner.CornerRadius = UDim.new(0, 4) -- Уменьшен угол
        petCorner.Parent = petButton
        
        local petStroke = Instance.new("UIStroke")
        petStroke.Color = Color3.fromRGB(100, 100, 100)
        petStroke.Thickness = 1 -- Уменьшена толщина
        petStroke.Transparency = 0.7
        petStroke.Parent = petButton
        
        local padding = Instance.new("UIPadding")
        padding.PaddingLeft = UDim.new(0, 3) -- Уменьшен отступ
        padding.Parent = petButton
        
        petButtons[i] = {
            button = petButton,
            stroke = petStroke,
            index = i
        }
        
        -- Только для ПК добавляем эффекты при наведении
        if not isMobile then
            petButton.MouseEnter:Connect(function()
                if selectedTargetIndex ~= i then
                    petButton.BackgroundTransparency = 0.05
                    petStroke.Transparency = 0.5
                end
            end)
            
            petButton.MouseLeave:Connect(function()
                if selectedTargetIndex ~= i then
                    petButton.BackgroundTransparency = 0.15
                    petStroke.Transparency = 0.7
                end
            end)
        end
        
        petButton.MouseButton1Click:Connect(function()
            selectedTargetIndex = i
            
            -- Обновляем стили кнопок
            for j, btn in ipairs(petButtons) do
                if j == selectedTargetIndex then
                    btn.button.TextColor3 = Color3.fromRGB(100, 255, 100)
                    btn.stroke.Color = Color3.fromRGB(100, 255, 100)
                    btn.stroke.Transparency = 0.3
                else
                    btn.button.TextColor3 = Color3.fromRGB(200, 200, 200)
                    btn.stroke.Color = Color3.fromRGB(100, 100, 100)
                    btn.stroke.Transparency = 0.7
                end
            end
            
            local topPets = get_top_3_pets()
            if topPets[selectedTargetIndex] then
                local currentPet = topPets[selectedTargetIndex]
                targetLabel.Text = string.format("Current: %s", currentPet.petName) -- Укорочено
            else
                targetLabel.Text = "Current: None"
            end
        end)
    end

    toggleButton = Instance.new("TextButton")
    toggleButton.Size = UDim2.new(0, frameWidth - 20, 0, 28) -- Уменьшено
    toggleButton.Position = UDim2.new(0, 10, 0, startY + 3 * buttonSpacing)
    toggleButton.BackgroundColor3 = Color3.fromRGB(15, 0, 15)
    toggleButton.BackgroundTransparency = 0.15
    toggleButton.BorderSizePixel = 0
    toggleButton.Text = "Disable"
    toggleButton.Font = Enum.Font.GothamBold
    toggleButton.TextSize = isMobile and 10 or 12 -- Уменьшено
    toggleButton.TextColor3 = Color3.fromRGB(230, 175, 255)
    toggleButton.AutoButtonColor = false
    toggleButton.ZIndex = 101
    toggleButton.Parent = frame

    local buttonCorner = Instance.new("UICorner")
    buttonCorner.CornerRadius = UDim.new(0, 4) -- Уменьшен угол
    buttonCorner.Parent = toggleButton

    local buttonGradient = Instance.new("UIGradient")
    buttonGradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.fromRGB(200, 100, 255)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 220, 255))
    }
    buttonGradient.Parent = toggleButton

    local buttonStroke = Instance.new("UIStroke")
    buttonStroke.Color = Color3.fromRGB(180, 0, 255)
    buttonStroke.Thickness = 1 -- Уменьшена толщина
    buttonStroke.Transparency = 0.5
    buttonStroke.Parent = toggleButton
    
    -- Инициализация стилей кнопок
    for i, btn in ipairs(petButtons) do
        if i == selectedTargetIndex then
            btn.button.TextColor3 = Color3.fromRGB(100, 255, 100)
            btn.stroke.Color = Color3.fromRGB(100, 255, 100)
            btn.stroke.Transparency = 0.3
        else
            btn.button.TextColor3 = Color3.fromRGB(200, 200, 200)
            btn.stroke.Color = Color3.fromRGB(100, 100, 100)
            btn.stroke.Transparency = 0.7
        end
    end
    
    -- Добавляем родителя в конце
    screenGui.Parent = PlayerGui
    
    -- Для мобильных устройств добавляем кнопку скрытия/показа
    if isMobile then
        local closeButton = Instance.new("TextButton")
        closeButton.Size = UDim2.new(0, 25, 0, 25) -- Уменьшено
        closeButton.Position = UDim2.new(1, -30, 0, 2) -- Смещено
        closeButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
        closeButton.BackgroundTransparency = 0.3
        closeButton.BorderSizePixel = 0
        closeButton.Text = "X"
        closeButton.Font = Enum.Font.GothamBold
        closeButton.TextSize = 12 -- Уменьшено
        closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
        closeButton.ZIndex = 101
        closeButton.Parent = frame
        
        local closeCorner = Instance.new("UICorner")
        closeCorner.CornerRadius = UDim.new(0, 4) -- Уменьшен угол
        closeCorner.Parent = closeButton
        
        closeButton.MouseButton1Click:Connect(function()
            frame.Visible = not frame.Visible
            closeButton.Text = frame.Visible and "X" or "O"
        end)
    end
    
    return true
end

local function updateUI(enabled, topPets)
    -- Защита от nil значений
    if not statusLabel or not targetLabel or not toggleButton then
        return
    end
    
    autoStealEnabled = enabled
    
    if enabled then
        statusLabel.Text = "ON"
        statusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
        
        if frame and frame:FindFirstChild("UIStroke") then
            frame.UIStroke.Color = Color3.fromRGB(100, 255, 100)
            frame.UIStroke.Transparency = 0.3
        end
        
        toggleButton.Text = "Disable"
        
        if topPets and type(topPets) == "table" and petButtons then
            for i = 1, 3 do
                if petButtons[i] and petButtons[i].button then
                    if topPets[i] then
                        local pet = topPets[i]
                        -- Укороченный формат
                        petButtons[i].button.Text = string.format("#%d: %s", i, pet.petName or "?")
                    else
                        petButtons[i].button.Text = string.format("#%d: No", i)
                    end
                end
            end
            
            if topPets[selectedTargetIndex] then
                local currentPet = topPets[selectedTargetIndex]
                targetLabel.Text = string.format("Current: %s", currentPet.petName or "?")
            else
                targetLabel.Text = "Current: None"
            end
        else
            targetLabel.Text = "Current: Searching..."
            if petButtons then
                for i = 1, 3 do
                    if petButtons[i] and petButtons[i].button then
                        petButtons[i].button.Text = string.format("#%d: ...", i)
                    end
                end
            end
        end
        
        if petButtons then
            for i, btn in ipairs(petButtons) do
                if i == selectedTargetIndex and btn.button and btn.stroke then
                    btn.button.TextColor3 = Color3.fromRGB(100, 255, 100)
                    btn.stroke.Color = Color3.fromRGB(100, 255, 100)
                    btn.stroke.Transparency = 0.3
                elseif btn.button and btn.stroke then
                    btn.button.TextColor3 = Color3.fromRGB(200, 200, 200)
                    btn.stroke.Color = Color3.fromRGB(100, 100, 100)
                    btn.stroke.Transparency = 0.7
                end
            end
        end
    else
        statusLabel.Text = "OFF"
        statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        
        if frame and frame:FindFirstChild("UIStroke") then
            frame.UIStroke.Color = Color3.fromRGB(180, 0, 255)
            frame.UIStroke.Transparency = 0.5
        end
        
        toggleButton.Text = "Enable"
        targetLabel.Text = "Current: Off"
        
        if petButtons then
            for i = 1, 3 do
                if petButtons[i] and petButtons[i].button then
                    petButtons[i].button.Text = string.format("#%d: Off", i)
                    petButtons[i].button.TextColor3 = Color3.fromRGB(150, 150, 150)
                end
            end
        end
    end
end

local function updateStealStatus()
    if not stealStatusLabel or not progressFill or not progressText then
        return
    end
    
    if isCurrentlyStealing then
        stealStatusLabel.Text = "Steal: In Progress"
        stealStatusLabel.TextColor3 = Color3.fromRGB(255, 200, 50)
        
        -- Обновляем полоску прогресса
        local fillWidth = math.clamp(currentStealProgress, 0, 100)
        progressFill.Size = UDim2.new(fillWidth / 100, 0, 1, 0)
        progressText.Text = string.format("%.0f%%", fillWidth)
        
        -- Меняем цвет в зависимости от прогресса
        if fillWidth < 30 then
            progressFill.BackgroundColor3 = Color3.fromRGB(255, 50, 50) -- Красный
        elseif fillWidth < 70 then
            progressFill.BackgroundColor3 = Color3.fromRGB(255, 200, 50) -- Желтый
        else
            progressFill.BackgroundColor3 = Color3.fromRGB(100, 255, 100) -- Зеленый
        end
    else
        stealStatusLabel.Text = "Steal: Ready"
        stealStatusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
        
        -- Сбрасываем полоску прогресса
        progressFill.Size = UDim2.new(0, 0, 1, 0)
        progressText.Text = "0%"
        progressFill.BackgroundColor3 = Color3.fromRGB(100, 255, 100)
    end
end

local stealConnection = nil

local function autoStealLoop()
    if stealConnection then
        stealConnection:Disconnect()
    end
    
    stealConnection = RunService.Heartbeat:Connect(function()
        if not autoStealEnabled then
            return
        end
        
        local topPets = get_top_3_pets()
        
        local targetAnimal = nil
        if topPets[selectedTargetIndex] then
            targetAnimal = topPets[selectedTargetIndex].animalData
        end
        
        if not targetAnimal or isMyBaseAnimal(targetAnimal) then
            return
        end
        
        local prompt = PromptMemoryCache[targetAnimal.uid]
        if not prompt or not prompt.Parent then
            prompt = findProximityPromptForAnimal(targetAnimal)
        end
        
        if prompt then
            attemptSteal(prompt)
        end
        
        -- Обновляем статус кражи каждый кадр
        updateStealStatus()
    end)
end

-- Основной поток инициализации
task.spawn(function()
    -- Ждем загрузки необходимых модулей
    print("Ожидание загрузки модулей...")
    while not AnimalsData or not AnimalsShared or not NumberUtils do
        task.wait(0.5)
    end
    
    print("Модули загружены, создаем GUI...")
    
    -- Ждем немного перед созданием GUI
    task.wait(2)
    
    -- Создаем GUI
    local guiCreated = createMobileGUI()
    if not guiCreated then
        warn("Не удалось создать GUI!")
        return
    end
    
    print("GUI создан успешно!")
    
    -- Настройка кнопки toggle
    if toggleButton then
        local isMobile = UserInputService.TouchEnabled
        
        if not isMobile then
            toggleButton.MouseEnter:Connect(function()
                toggleButton.BackgroundTransparency = 0.05
                if toggleButton:FindFirstChild("UIStroke") then
                    toggleButton.UIStroke.Transparency = 0.3
                end
            end)

            toggleButton.MouseLeave:Connect(function()
                toggleButton.BackgroundTransparency = 0.15
                if toggleButton:FindFirstChild("UIStroke") then
                    toggleButton.UIStroke.Transparency = 0.5
                end
            end)
        end

        toggleButton.MouseButton1Click:Connect(function()
            autoStealEnabled = not autoStealEnabled
            
            if autoStealEnabled then
                local topPets = get_top_3_pets()
                updateUI(true, topPets)
                autoStealLoop()
            else
                updateUI(false)
                -- Сбрасываем статус кражи при выключении
                isCurrentlyStealing = false
                currentStealProgress = 0
                updateStealStatus()
            end
        end)
    end
    
    -- Инициализация сканера
    print("Инициализация сканера...")
    initializePlotScanner()
    
    -- Запуск авто-кражи
    task.wait(1)
    autoStealLoop()
    
    -- Первоначальное обновление UI
    local topPets = get_top_3_pets()
    updateUI(true, topPets)
    
    print("Auto Steal готов к работе!")
    
    -- Обновление UI каждые 0.1 секунды для плавной анимации прогресса
    while task.wait(0.1) do
        if autoStealEnabled then
            local topPets = get_top_3_pets()
            updateUI(true, topPets)
            updateStealStatus()
        end
    end
end)

print("Auto steal loaded by NexoraHub (Mini Mobile UI by Gymo)")
